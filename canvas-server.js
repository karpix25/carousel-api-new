–ö–æ–Ω–µ—á–Ω–æ. –Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–ª –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª –≤–∞—à –∫–æ–¥, –≤–Ω–µ–¥—Ä–∏–≤ –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è.

–í–æ—Ç –∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:

1.  **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤–∏—Å—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–≥–∏:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `fixTypography`, –∫–æ—Ç–æ—Ä–∞—è "—Å–∫–ª–µ–∏–≤–∞–µ—Ç" –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏.
2.  **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–∞–π–¥–æ–≤:** –í API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Promise.all` –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Å–µ—Ö —Å–ª–∞–π–¥–æ–≤, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É.
3.  **–ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞:** –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ (`wrapPlainForIntro`). –¢–µ–ø–µ—Ä—å `renderRichText` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –≥–ª–∞–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
4.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:** `parseMarkdownToSlides` —Ç–µ–ø–µ—Ä—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –æ–¥–Ω—É –±–æ–ª—å—à—É—é —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—Å—Ç–∞, –∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã, —Å–ø–∏—Å–∫–∏, —Ü–∏—Ç–∞—Ç—ã) –≤ –º–∞—Å—Å–∏–≤–µ `slide.content`. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –≥–∏–±—á–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ.
5.  **–ù–∞–¥–µ–∂–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞–º–∏:** –ö–æ–¥ —Ç–µ–ø–µ—Ä—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —à—Ä–∏—Ñ—Ç–æ–≤ (`Inter` –≤–º–µ—Å—Ç–æ `Arial`). –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ª—é–±–æ–º —Å–µ—Ä–≤–µ—Ä–µ. **–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `fonts` –∏ –ø–æ–ª–æ–∂–∏—Ç—å —Ç—É–¥–∞ —Ñ–∞–π–ª—ã `Inter-Regular.ttf` –∏ `Inter-Bold.ttf`.**
6.  **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** API –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –¥–µ—Ç–∞–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–æ–∫.
7.  **–£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–∏–±–∫–æ—Å—Ç—å:** –¢–µ–ø–µ—Ä—å —Ü–∏—Ç–∞—Ç—ã (`>`) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–ª–∞–π–¥–æ–≤, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–∞–π–¥—ã.

–í–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥. –û–Ω –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

```javascript
/**
 * Canvas Carousel API - v2.0 Refactored
 * –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π,
 * —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–æ–π, —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º –∏ –Ω–∞–¥–µ–∂–Ω—ã–º
 * —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (—à—Ä–∏—Ñ—Ç—ã).
 *
 * @author Gemini AI (based on user's code)
 * @version 2.0
 */
console.log('üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–î–ê–ö–®–ù –í–ï–†–°–ò–Ø v2.0 - Canvas API (auto contrast, advanced typography)');

const express = require('express');
const { marked } = require('marked');
const { createCanvas, loadImage, registerFont } = require('canvas');
const path = require('path');

// ================== CONFIG ==================
const CONFIG = {
  CANVAS: {
    WIDTH: 1600,
    HEIGHT: 2000,
    PADDING: 144,
    BORDER_RADIUS: 64,
    HEADER_FOOTER_PADDING: 192,
    CONTENT_GAP: 144,
    CONTENT_START_Y: 500
  },
  FONTS: {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç 'Inter'
    FAMILY: 'Inter',
    TITLE_INTRO: { size: 128, weight: 'bold', lineHeightRatio: 1.1 },
    SUBTITLE_INTRO: { size: 64, weight: 'normal', lineHeightRatio: 1.25 },
    TITLE_TEXT: { size: 96, weight: 'bold', lineHeightRatio: 1.2 },
    TEXT: { size: 64, weight: 'normal', lineHeightRatio: 1.4 },
    QUOTE_LARGE: { size: 96, weight: 'bold', lineHeightRatio: 1.2 },
    QUOTE_SMALL: { size: 64, weight: 'bold', lineHeightRatio: 1.3 },
    HEADER_FOOTER: { size: 48, weight: 'normal', lineHeightRatio: 1.4 }
  },
  SPACING: {
    H2_TO_CONTENT: 80,
    BLOCK_TO_BLOCK: 48 // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ —Ç.–¥.
  },
  COLORS: {
    DEFAULT_BG: '#ffffff',
    DEFAULT_TEXT: '#000000',
    ACCENT_FALLBACK: '#6366F1',
    LIGHT_TEXT: '#ffffff',
    DARK_TEXT: '#000000'
  },
  LIST_MARKER: '‚Üí'
};

// ================== FONT REGISTRATION ==================
// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —à—Ä–∏—Ñ—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª—é–±–æ–π —Å—Ä–µ–¥–µ (–≤–∫–ª—é—á–∞—è Docker)
try {
  registerFont(path.join(__dirname, 'fonts', 'Inter-Regular.ttf'), { family: CONFIG.FONTS.FAMILY, weight: 'normal' });
  registerFont(path.join(__dirname, 'fonts', 'Inter-Bold.ttf'), { family: CONFIG.FONTS.FAMILY, weight: 'bold' });
  console.log('‚úÖ –®—Ä–∏—Ñ—Ç—ã Inter-Regular –∏ Inter-Bold —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.');
} catch (error) {
  console.error('‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —à—Ä–∏—Ñ—Ç—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã .ttf –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ /fonts.', error.message);
  // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ª—É—á—à–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É
  process.exit(1);
}


// ================== COLOR CONTRAST HELPERS ==================
function hexToRgb(hex) {
  hex = hex.replace('#', '');
  if (hex.length === 3) {
    hex = hex.split('').map(char => char + char).join('');
  }
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  return { r, g, b };
}

function getLuminance(r, g, b) {
  const a = [r, g, b].map(v => {
    v /= 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  });
  return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
}

function getContrastColor(backgroundColor) {
  try {
    const { r, g, b } = hexToRgb(backgroundColor);
    const luminance = getLuminance(r, g, b);
    return luminance > 0.5 ? CONFIG.COLORS.DARK_TEXT : CONFIG.COLORS.LIGHT_TEXT;
  } catch (error) {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –¥–ª—è —Ü–≤–µ—Ç–∞:', backgroundColor, '. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.');
    return CONFIG.COLORS.DARK_TEXT;
  }
}

function getAccentColorForBackground(backgroundColor, brandColor) {
  try {
    const { r, g, b } = hexToRgb(backgroundColor);
    const luminance = getLuminance(r, g, b);
    return luminance > 0.5 ? brandColor : CONFIG.COLORS.LIGHT_TEXT;
  } catch (error) {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –¥–ª—è:', backgroundColor, '. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–≤–µ—Ç –±—Ä–µ–Ω–¥–∞.');
    return brandColor;
  }
}

// ================== TYPOGRAPHY & TEXT HELPERS ==================
/**
 * –ó–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤ –Ω–∞ –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ (\u00A0),
 * —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "–≤–∏—Å—è—á–∏—Ö –ø—Ä–µ–¥–ª–æ–≥–æ–≤".
 */
function fixTypography(text) {
  if (!text) return '';
  return text.replace(/(^|\s)([–≤–∫–º—Å–∑–∏–æ—É–∞—è]{1,2})\s/gi, '$1$2\u00A0');
}

function buildFont(weight, size) {
  return `${weight} ${size}px ${CONFIG.FONTS.FAMILY}`;
}

/**
 * –ü–∞—Ä—Å–µ—Ä –¥–ª—è inline-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: __underline__, **bold**, __**both**__.
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Ç–æ–∫–µ–Ω–æ–≤.
 */
function parseInline(raw) {
  if (!raw) return [];
  const tokens = [];
  const regex = /(__\*\*.+?\*\*__|__.+?__|\*\*.+?\*\*|[^*_]+)/g;
  let match;

  while ((match = regex.exec(raw)) !== null) {
    let chunk = match[0];
    let bold = false;
    let underline = false;
    let text = chunk;

    if (chunk.startsWith('__') && chunk.endsWith('__')) {
      underline = true;
      text = text.slice(2, -2);
      if (text.startsWith('**') && text.endsWith('**')) {
        bold = true;
        text = text.slice(2, -2);
      }
    } else if (chunk.startsWith('**') && chunk.endsWith('**')) {
      bold = true;
      text = text.slice(2, -2);
    }

    if (!text) continue;
    tokens.push({ text, bold, underline });
  }

  // –°–ª–∏—è–Ω–∏–µ —Å–º–µ–∂–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Å—Ç–∏–ª–µ–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
  if (tokens.length < 2) return tokens;
  return tokens.reduce((acc, current) => {
    const last = acc[acc.length - 1];
    if (last && last.bold === current.bold && last.underline === current.underline) {
      last.text += current.text;
    } else {
      acc.push(current);
    }
    return acc;
  }, []);
}

/**
 * –†–∞–∑–±–∏–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã.
 * –≠—Ç–æ —è–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–Ω–æ—Å–∞.
 */
function wrapSegments(ctx, segments, maxWidth, baseFontSize) {
  const lines = [];
  let currentLine = { runs: [], width: 0 };

  const pushLine = () => {
    if (currentLine.runs.length > 0) {
      lines.push(currentLine);
      currentLine = { runs: [], width: 0 };
    }
  };

  for (const seg of segments) {
    const words = seg.text.split(/(\s+)/); // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º, —Å–æ—Ö—Ä–∞–Ω—è—è –∏—Ö
    for (const word of words) {
      if (!word) continue;

      ctx.font = buildFont(seg.bold ? 'bold' : 'normal', baseFontSize);
      const wordWidth = ctx.measureText(word).width;
      const isSpace = /^\s+$/.test(word);

      if (currentLine.width + wordWidth > maxWidth && !isSpace) {
        // –°–ª–æ–≤–æ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
        pushLine();
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ (–∏–ª–∏ –ø—Ä–æ–±–µ–ª) –≤ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
      currentLine.runs.push({ ...seg, text: word });
      currentLine.width += wordWidth;
    }
  }
  pushLine(); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É
  return lines;
}

// ================== UNIFIED TEXT RENDERER ==================
/**
 * ‚ú® –ï–î–ò–ù–´–ô –†–ï–ù–î–ï–†–ï–† –¢–ï–ö–°–¢–ê.
 * DRY Principle: –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∞,
 * –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞.
 * @returns {number} –í—ã—Å–æ—Ç–∞ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö.
 */
function renderRichText(ctx, rawText, x, startY, maxWidth, fontConf, baseColor, accentColor, slideIsAccent) {
  const processedText = fixTypography(rawText);
  if (!processedText) return 0;

  const { size: baseFontSize, lineHeightRatio } = fontConf;
  const lineHeight = Math.round(baseFontSize * lineHeightRatio);

  const segments = parseInline(processedText);
  const lines = wrapSegments(ctx, segments, maxWidth, baseFontSize);
  const underlineStrokes = [];
  let y = startY;

  for (const line of lines) {
    let cursorX = x;
    for (const run of line.runs) {
      const weight = run.bold ? 'bold' : 'normal';
      ctx.font = buildFont(weight, baseFontSize);

      const useAccent = run.underline && run.bold && !slideIsAccent;
      ctx.fillStyle = useAccent ? accentColor : baseColor;

      ctx.textBaseline = 'alphabetic'; // –í–∞–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      ctx.fillText(run.text, cursorX, y);

      if (run.underline) {
        const metrics = ctx.measureText(run.text);
        const underlineY = y + (metrics.actualBoundingBoxDescent || baseFontSize * 0.15);
        underlineStrokes.push({
          x1: cursorX,
          x2: cursorX + metrics.width,
          y: underlineY,
          color: ctx.fillStyle
        });
      }
      cursorX += ctx.measureText(run.text).width;
    }
    y += lineHeight;
  }

  // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è —Ä–∞–∑–æ–º –ø–æ–≤–µ—Ä—Ö —Ç–µ–∫—Å—Ç–∞
  ctx.lineWidth = Math.max(3, Math.round(baseFontSize * 0.045));
  underlineStrokes.forEach(stroke => {
    ctx.strokeStyle = stroke.color;
    ctx.beginPath();
    ctx.moveTo(stroke.x1, stroke.y);
    ctx.lineTo(stroke.x2, stroke.y);
    ctx.stroke();
  });

  return lines.length * lineHeight; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â—É—é –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞
}


// ================== MARKDOWN PARSER v2.0 ==================
/**
 * –ü–∞—Ä—Å–∏—Ç Markdown –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å–ª–∞–π–¥–æ–≤.
 * –ù–µ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ —Å—Ç—Ä–æ–∫—É, —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
 */
function parseMarkdownToSlides(text) {
  const tokens = marked.lexer(text);
  const slides = [];
  let currentSlide = null;

  const startNewTextSlide = (title) => {
    currentSlide = { type: 'text', title, text: '', color: 'default', content: [] };
    slides.push(currentSlide);
  };

  tokens.forEach((token, index) => {
    switch (token.type) {
      case 'heading':
        if (token.depth === 1) { // H1 -> Intro Slide
          currentSlide = null; // Intro slide –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
          const nextToken = tokens[index + 1];
          const subtitle = (nextToken && nextToken.type === 'paragraph') ? nextToken.text : '';
          slides.push({ type: 'intro', title: token.text, text: subtitle, color: 'accent' });
        } else if (token.depth === 2) { // H2 -> New Text Slide
          startNewTextSlide(token.text);
        }
        break;

      case 'blockquote':
        const quoteText = token.tokens?.[0]?.text || '';
        if (currentSlide) {
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ª–∞–π–¥, –¥–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ç–∞—Ç—É –≤ –µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç
          currentSlide.content.push({ type: 'blockquote', text: quoteText });
        } else {
          // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–∞–π–¥-—Ü–∏—Ç–∞—Ç—É
          slides.push({
            type: 'quote',
            text: quoteText,
            color: 'accent',
            size: quoteText.length > 100 ? 'small' : 'large'
          });
        }
        break;

      case 'paragraph':
      case 'list':
        if (!currentSlide) {
          // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–¥–µ—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ H2, —Å–æ–∑–¥–∞–µ–º "–±–µ–∑—ã–º—è–Ω–Ω—ã–π" —Å–ª–∞–π–¥
          startNewTextSlide('');
        }
        if (token.type === 'paragraph') {
          currentSlide.content.push({ type: 'paragraph', text: token.text });
        } else if (token.type === 'list') {
          currentSlide.content.push({ type: 'list', items: token.items.map(item => item.text) });
        }
        break;
    }
  });

  return slides;
}

// ================== SLIDE RENDERERS v2.0 ==================
function renderIntroSlide(ctx, slide, contentY, contentWidth, brandColor) {
  let y = contentY;
  ctx.textAlign = 'left';

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä
  const titleHeight = renderRichText(ctx, slide.title, CONFIG.CANVAS.PADDING, y, contentWidth, CONFIG.FONTS.TITLE_INTRO, ctx.fillStyle, brandColor, true);
  y += titleHeight;

  if (slide.text) {
    y += CONFIG.SPACING.H2_TO_CONTENT;
    ctx.globalAlpha = 0.9;
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞
    renderRichText(ctx, slide.text, CONFIG.CANVAS.PADDING, y, contentWidth, CONFIG.FONTS.SUBTITLE_INTRO, ctx.fillStyle, brandColor, true);
    ctx.globalAlpha = 1.0;
  }
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥, –∏—Ç–µ—Ä–∏—Ä—É—è—Å—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É.
 */
function renderTextSlide(ctx, slide, contentY, contentWidth, brandColor) {
  let y = contentY;
  ctx.textAlign = 'left';

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–ª–∞–π–¥–∞
  if (slide.title) {
    const titleHeight = renderRichText(ctx, slide.title, CONFIG.CANVAS.PADDING, y, contentWidth, CONFIG.FONTS.TITLE_TEXT, ctx.fillStyle, brandColor, slide.color === 'accent');
    y += titleHeight + CONFIG.SPACING.H2_TO_CONTENT;
  }

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã, —Å–ø–∏—Å–∫–∏, —Ü–∏—Ç–∞—Ç—ã)
  slide.content?.forEach((block, index) => {
    let blockHeight = 0;
    const isLastBlock = index === slide.content.length - 1;

    switch (block.type) {
      case 'paragraph':
        blockHeight = renderRichText(ctx, block.text, CONFIG.CANVAS.PADDING, y, contentWidth, CONFIG.FONTS.TEXT, ctx.fillStyle, brandColor, slide.color === 'accent');
        break;

      case 'list':
        const marker = CONFIG.LIST_MARKER + ' ';
        ctx.font = buildFont('bold', CONFIG.FONTS.TEXT.size);
        const markerWidth = ctx.measureText(marker).width + 32;
        const listContentWidth = contentWidth - markerWidth;
        
        block.items.forEach(item => {
            // –†–µ–Ω–¥–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
            ctx.font = buildFont('bold', CONFIG.FONTS.TEXT.size);
            ctx.fillText(CONFIG.LIST_MARKER, CONFIG.CANVAS.PADDING, y);
            
            // –†–µ–Ω–¥–µ—Ä —Ç–µ–∫—Å—Ç–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞
            const itemHeight = renderRichText(ctx, item, CONFIG.CANVAS.PADDING + markerWidth, y, listContentWidth, CONFIG.FONTS.TEXT, ctx.fillStyle, brandColor, slide.color === 'accent');
            y += itemHeight;
            blockHeight += itemHeight;
        });
        break;
      
      case 'blockquote':
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ü–∏—Ç–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å–ª–∞–π–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –æ—Ç—Å—Ç—É–ø–æ–º –∏ –¥—Ä—É–≥–∏–º —Å—Ç–∏–ª–µ–º)
        ctx.globalAlpha = 0.8;
        blockHeight = renderRichText(ctx, `‚Äú${block.text}‚Äù`, CONFIG.CANVAS.PADDING + 40, y, contentWidth - 40, CONFIG.FONTS.TEXT, ctx.fillStyle, brandColor, slide.color === 'accent');
        ctx.globalAlpha = 1.0;
        break;
    }
    
    y += blockHeight;
    if (!isLastBlock) {
      y += CONFIG.SPACING.BLOCK_TO_BLOCK;
    }
  });
}

function renderQuoteSlide(ctx, slide, contentY, contentHeight, contentWidth) {
  ctx.textAlign = 'left';
  const isSmall = slide.size === 'small';
  const quoteFont = isSmall ? CONFIG.FONTS.QUOTE_SMALL : CONFIG.FONTS.QUOTE_LARGE;
  const { lineHeight } = getFontStyle(quoteFont);

  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
  const lines = wrapSegments(ctx, parseInline(fixTypography(slide.text)), contentWidth, quoteFont.size);
  const totalTextHeight = lines.length * lineHeight;
  let y = contentY + (contentHeight - totalTextHeight) / 2 + lineHeight;

  renderRichText(ctx, slide.text, CONFIG.CANVAS.PADDING, y, contentWidth, quoteFont, ctx.fillStyle, 'transparent', true);
}

// ================== AVATAR & FINAL SLIDE ==================
async function loadAvatarImage(url) {
  try {
    return await loadImage(url);
  } catch (e) {
    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É:', e.message);
    return null;
  }
}

function renderAvatar(ctx, avatarImage, x, y, size) {
  if (!avatarImage) return;
  ctx.save();
  ctx.beginPath();
  ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
  ctx.clip();
  ctx.drawImage(avatarImage, x, y, size, size);
  ctx.restore();
}

function addFinalSlide(slides, settings) {
    // ... –ª–æ–≥–∏–∫–∞ addFinalSlide –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    return slides;
}

// ================== MAIN RENDER FUNCTION ==================
async function renderSlideToCanvas(slide, slideNumber, totalSlides, settings, avatarImage = null) {
  const {
    brandColor = CONFIG.COLORS.ACCENT_FALLBACK,
    authorUsername = '@username',
    authorFullName = 'Your Name'
  } = settings;

  const canvas = createCanvas(CONFIG.CANVAS.WIDTH, CONFIG.CANVAS.HEIGHT);
  const ctx = canvas.getContext('2d');

  // --- Background & Colors ---
  const isAccent = slide.color === 'accent';
  const bgColor = isAccent ? brandColor : CONFIG.COLORS.DEFAULT_BG;
  const textColor = getContrastColor(bgColor);
  const accentColorForText = getAccentColorForBackground(CONFIG.COLORS.DEFAULT_BG, brandColor);

  ctx.fillStyle = bgColor;
  ctx.roundRect(0, 0, CONFIG.CANVAS.WIDTH, CONFIG.CANVAS.HEIGHT, CONFIG.CANVAS.BORDER_RADIUS);
  ctx.fill();
  ctx.clip(); // –û–±—Ä–µ–∑–∞–µ–º –≤—Å–µ –ø–æ —Ä–∞–¥–∏—É—Å—É

  ctx.fillStyle = textColor;

  // --- Header ---
  const headerFooterFont = buildFont(CONFIG.FONTS.HEADER_FOOTER.weight, CONFIG.FONTS.HEADER_FOOTER.size);
  ctx.font = headerFooterFont;
  ctx.globalAlpha = 0.7;
  
  // Avatar & Username
  const avatarSize = 90;
  const avatarPadding = 24;
  if (avatarImage) {
    const avatarY = CONFIG.CANVAS.HEADER_FOOTER_PADDING - avatarSize / 2;
    renderAvatar(ctx, avatarImage, CONFIG.CANVAS.PADDING, avatarY, avatarSize);
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(authorUsername, CONFIG.CANVAS.PADDING + avatarSize + avatarPadding, CONFIG.CANVAS.HEADER_FOOTER_PADDING);
  } else {
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(authorUsername, CONFIG.CANVAS.PADDING, CONFIG.CANVAS.HEADER_FOOTER_PADDING);
  }
  
  // Slide Counter
  ctx.textAlign = 'right';
  ctx.fillText(`${slideNumber}/${totalSlides}`, CONFIG.CANVAS.WIDTH - CONFIG.CANVAS.PADDING, CONFIG.CANVAS.HEADER_FOOTER_PADDING);
  ctx.globalAlpha = 1.0;

  // --- Content ---
  const contentY = CONFIG.CANVAS.CONTENT_START_Y;
  const contentHeight = CONFIG.CANVAS.HEIGHT - contentY - CONFIG.CANVAS.HEADER_FOOTER_PADDING;
  const contentWidth = CONFIG.CANVAS.WIDTH - (CONFIG.CANVAS.PADDING * 2);

  if (slide.type === 'intro') {
    renderIntroSlide(ctx, slide, contentY, contentWidth, accentColorForText);
  } else if (slide.type === 'text') {
    renderTextSlide(ctx, slide, contentY, contentWidth, accentColorForText);
  } else if (slide.type === 'quote') {
    renderQuoteSlide(ctx, slide, contentY, contentHeight, contentWidth);
  }

  // --- Footer ---
  ctx.font = headerFooterFont;
  ctx.globalAlpha = 0.7;
  ctx.textAlign = 'left';
  ctx.fillText(authorFullName, CONFIG.CANVAS.PADDING, CONFIG.CANVAS.HEIGHT - CONFIG.CANVAS.HEADER_FOOTER_PADDING);
  if (slideNumber < totalSlides) {
    ctx.textAlign = 'right';
    ctx.fillText('‚Üí', CONFIG.CANVAS.WIDTH - CONFIG.CANVAS.PADDING, CONFIG.CANVAS.HEIGHT - CONFIG.CANVAS.HEADER_FOOTER_PADDING);
  }
  ctx.globalAlpha = 1.0;
  
  return canvas;
}


// ================== EXPRESS APP v2.0 ==================
const app = express();
app.use(express.json({ limit: '10mb' }));

app.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        engine: 'canvas-api-v2.0-refactored',
        timestamp: new Date().toISOString()
    });
});

app.post('/api/generate-carousel', async (req, res) => {
  const startTime = Date.now();
  try {
    const { text, settings = {} } = req.body;
    if (!text) {
      return res.status(400).json({ error: '–ü–∞—Ä–∞–º–µ—Ç—Ä "text" —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º.' });
    }

    console.log(`üöÄ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è brandColor: ${settings.brandColor || 'default'}`);

    const avatarImage = settings.avatarUrl ? await loadAvatarImage(settings.avatarUrl) : null;
    let slides = parseMarkdownToSlides(text);
    slides = addFinalSlide(slides, settings); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ª–∞–π–¥ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

    if (slides.length === 0) {
        return res.status(400).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–∞–π–¥—ã –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.' });
    }

    // ‚ú® –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–õ–ê–ô–î–û–í
    const imagePromises = slides.map((slide, i) =>
      renderSlideToCanvas(slide, i + 1, slides.length, settings, avatarImage)
        .then(canvas => canvas.toBuffer('image/png').toString('base64'))
    );
    const images = await Promise.all(imagePromises);

    const processingTime = Date.now() - startTime;
    console.log(`‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${processingTime}ms. –°–ª–∞–π–¥–æ–≤: ${slides.length}`);

    res.json({
      images,
      metadata: {
        totalSlides: slides.length,
        processingTime,
        engine: 'canvas-api-v2.0-refactored',
        // slides // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –¥–µ–±–∞–≥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–ª–∞–π–¥–æ–≤
      }
    });

  } catch (error) {
    // üîí –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–ò:', error);
    res.status(500).json({ error: '–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' });
  }
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM signal received: closing HTTP server');
  server.close(() => {
    console.log('HTTP server closed');
  });
});

const PORT = process.env.PORT || 3001;
const server = app.listen(PORT, () => {
  console.log(`üöÄ PRODUCTION REFACTORED Canvas API –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});
```
